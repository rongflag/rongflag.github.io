<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0"
  xmlns:atom="http://www.w3.org/2005/Atom"
  xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>aihuxi</title>
    <link>http://rongflag.github.io/</link>
    
    <atom:link href="/rss.xml" rel="self" type="application/rss+xml"/>
    
    <description>çˆ±å‘¼å¸çš„é±¼ğŸ å’•æ³¡æ³¡ï¼Œå’•å˜Ÿå’•å˜Ÿ~~</description>
    <pubDate>Sat, 14 Mar 2020 09:32:29 GMT</pubDate>
    <generator>http://hexo.io/</generator>
    
    <item>
      <title>security(6)è‡ªåŠ¨ ç™»å½•</title>
      <link>http://rongflag.github.io/posts/security6.html</link>
      <guid>http://rongflag.github.io/posts/security6.html</guid>
      <pubDate>Thu, 12 Dec 2019 16:00:00 GMT</pubDate>
      <description>
      
        &lt;p&gt;è‡ªåŠ¨ç™»å½•å¾ˆç®€å•cookieå’Œdatabseã€‚ã€‚æ‹‰èƒ¯äº†ï¼Œæ‹‰èƒ¯äº† ä»¥ååœ¨è¯´å§&lt;/p&gt;
      
      </description>
      
      
      <content:encoded><![CDATA[<p>è‡ªåŠ¨ç™»å½•å¾ˆç®€å•cookieå’Œdatabseã€‚ã€‚æ‹‰èƒ¯äº†ï¼Œæ‹‰èƒ¯äº† ä»¥ååœ¨è¯´å§</p><a id="more"></a><p>å…¨æ–‡å†…å®¹</p><h1 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h1><p>æ•°æ®åº“ç”¨æˆ·è¿™äº›å’Œä»¥å‰ä¸€æ ·å°±ä¸è¯´äº†ã€‚poå‡ºé…ç½®å§ï¼Œä½†æ˜¯éƒ½éœ€è¦cookie</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span>(debug = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.security.remember-me.key&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String rememberKey;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        JdbcTokenRepositoryImpl tokenRepository = <span class="keyword">new</span> JdbcTokenRepositoryImpl();</span><br><span class="line"></span><br><span class="line">        tokenRepository.setDataSource(dataSource);</span><br><span class="line"></span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">"/admin/**"</span>)</span><br><span class="line">                .hasRole(<span class="string">"admin"</span>)</span><br><span class="line">                .antMatchers(<span class="string">"/user/**"</span>)</span><br><span class="line">                .hasRole(<span class="string">"user"</span>)</span><br><span class="line">                .antMatchers(<span class="string">"/api/**"</span>)</span><br><span class="line">                .permitAll()</span><br><span class="line">                .anyRequest()</span><br><span class="line">                .authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">                .rememberMe()</span><br><span class="line">                .userDetailsService(userDetailsService)</span><br><span class="line"><span class="comment">//                è¿™ä¸ªå¯ä»¥é‡å†™è‡ªå®šè®°å½•çš„é€»è¾‘  å®ç°AbstractRememberMeServices</span></span><br><span class="line"><span class="comment">//                .rememberMeServices(myremenberService)</span></span><br><span class="line">                <span class="comment">// 1. æ•£åˆ—åŠ å¯†æ–¹æ¡ˆ è¿™ä¸ªå¯è¦å¯ä¸è¦</span></span><br><span class="line">                .key(rememberKey)</span><br><span class="line">                <span class="comment">// 7å¤©æœ‰æ•ˆæœŸ  ä¸è®¾ç½®é»˜è®¤ä¸¤å‘¨</span></span><br><span class="line">                .tokenValiditySeconds(<span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">7</span>)</span><br><span class="line">                <span class="comment">// 2. æŒä¹…åŒ–ä»¤ç‰Œæ–¹æ¡ˆ  ä¸é…ç½®å°±æ˜¯cookie é…ç½®äº†å°±æ˜¯æ•°æ®åº“</span></span><br><span class="line"><span class="comment">//                .tokenRepository(tokenRepository)</span></span><br><span class="line">                .and()</span><br><span class="line">                .logout()</span><br><span class="line">                .logoutUrl(<span class="string">"/myLogout"</span>)</span><br><span class="line">                <span class="comment">// æ³¨é”€æˆåŠŸï¼Œé‡å®šå‘åˆ°è¯¥è·¯å¾„ä¸‹</span></span><br><span class="line">                .logoutSuccessUrl(<span class="string">"/"</span>)</span><br><span class="line">                .invalidateHttpSession(<span class="keyword">true</span>)</span><br><span class="line">                .and()</span><br><span class="line">                .csrf()</span><br><span class="line">                .disable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> NoOpPasswordEncoder.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å…³æ³¨çš„æºç "><a href="#å…³æ³¨çš„æºç " class="headerlink" title="å…³æ³¨çš„æºç "></a>å…³æ³¨çš„æºç </h2><h3 id="1-RememberMeConfigurer"><a href="#1-RememberMeConfigurer" class="headerlink" title="1. RememberMeConfigurer"></a>1. RememberMeConfigurer</h3><p>è¿™é‡Œé»˜è®¤ é»˜è®¤TokenBasedRememberMeServices</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> AbstractRememberMeServices <span class="title">createRememberMeServices</span><span class="params">(H http, String key)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.tokenRepository == <span class="keyword">null</span></span><br><span class="line">? createTokenBasedRememberMeServices(http, key)</span><br><span class="line">: createPersistentRememberMeServices(http, key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> AbstractRememberMeServices <span class="title">createTokenBasedRememberMeServices</span><span class="params">(H http,</span></span></span><br><span class="line"><span class="function"><span class="params">String key)</span> </span>&#123;</span><br><span class="line">UserDetailsService userDetailsService = getUserDetailsService(http);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> TokenBasedRememberMeServices(key, userDetailsService);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> PersistentTokenRepository tokenRepository = <span class="keyword">new</span> InMemoryTokenRepositoryImpl()ï¼›</span><br><span class="line">    è¿™é‡Œæ˜¯</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private AbstractRememberMeServices createRememberMeServices(H http, String key)</span><br><span class="line">throws Exception &#123;</span><br><span class="line">return this.tokenRepository &#x3D;&#x3D; null</span><br><span class="line">? createTokenBasedRememberMeServices(http, key)</span><br><span class="line">: createPersistentRememberMeServices(http, key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€æœ‰é‡å†™éƒ½å¯ä»¥æ ¹æ®è¿™ä¸ªé‡Œé¢éœ€è¦çš„è¿›è¡Œé…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_REMEMBER_ME_NAME = <span class="string">"remember-me"</span>;</span><br><span class="line"><span class="keyword">private</span> AuthenticationSuccessHandler authenticationSuccessHandler;</span><br><span class="line"><span class="keyword">private</span> String key;</span><br><span class="line"><span class="keyword">private</span> RememberMeServices rememberMeServices;</span><br><span class="line"><span class="keyword">private</span> LogoutHandler logoutHandler;</span><br><span class="line"><span class="keyword">private</span> String rememberMeParameter = DEFAULT_REMEMBER_ME_NAME;</span><br><span class="line"><span class="keyword">private</span> String rememberMeCookieName = DEFAULT_REMEMBER_ME_NAME;</span><br><span class="line"><span class="keyword">private</span> String rememberMeCookieDomain;</span><br><span class="line"><span class="keyword">private</span> PersistentTokenRepository tokenRepository;</span><br><span class="line"><span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"><span class="keyword">private</span> Integer tokenValiditySeconds;</span><br><span class="line"><span class="keyword">private</span> Boolean useSecureCookie;</span><br><span class="line"><span class="keyword">private</span> Boolean alwaysRemember;</span><br></pre></td></tr></table></figure><h3 id="1-AbstractRememberMeServices"><a href="#1-AbstractRememberMeServices" class="headerlink" title="1. AbstractRememberMeServices"></a>1. AbstractRememberMeServices</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> UserDetails <span class="title">processAutoLoginCookie</span><span class="params">(String[] cookieTokens,</span></span></span><br><span class="line"><span class="function"><span class="params">HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> RememberMeAuthenticationException, UsernameNotFoundException</span>;</span><br></pre></td></tr></table></figure><h3 id="1-1-TokenBasedRememberMeServices"><a href="#1-1-TokenBasedRememberMeServices" class="headerlink" title="1.1 TokenBasedRememberMeServices"></a>1.1 TokenBasedRememberMeServices</h3><p>ç”Ÿæˆæ•£åˆ—åŠ å¯†çš„éƒ¨åˆ†makeTokenSignature</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// åœ¨æˆåŠŸçš„éªŒè¯åç”Ÿæˆæ–°çš„token</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> UserDetails <span class="title">processAutoLoginCookie</span><span class="params">(String[] cookieTokens,</span></span></span><br><span class="line"><span class="function"><span class="params">HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (cookieTokens.length != <span class="number">3</span>) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> InvalidCookieException(<span class="string">"Cookie token did not contain 3"</span></span><br><span class="line">+ <span class="string">" tokens, but contained '"</span> + Arrays.asList(cookieTokens) + <span class="string">"'"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">long</span> tokenExpiryTime;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">tokenExpiryTime = <span class="keyword">new</span> Long(cookieTokens[<span class="number">1</span>]).longValue();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (NumberFormatException nfe) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> InvalidCookieException(</span><br><span class="line"><span class="string">"Cookie token[1] did not contain a valid number (contained '"</span></span><br><span class="line">+ cookieTokens[<span class="number">1</span>] + <span class="string">"')"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isTokenExpired(tokenExpiryTime)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> InvalidCookieException(<span class="string">"Cookie token[1] has expired (expired on '"</span></span><br><span class="line">+ <span class="keyword">new</span> Date(tokenExpiryTime) + <span class="string">"'; current time is '"</span> + <span class="keyword">new</span> Date()</span><br><span class="line">+ <span class="string">"')"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check the user exists.</span></span><br><span class="line"><span class="comment">// Defer lookup until after expiry time checked, to possibly avoid expensive</span></span><br><span class="line"><span class="comment">// database call.</span></span><br><span class="line"></span><br><span class="line">UserDetails userDetails = getUserDetailsService().loadUserByUsername(</span><br><span class="line">cookieTokens[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check signature of token matches remaining details.</span></span><br><span class="line"><span class="comment">// Must do this after user lookup, as we need the DAO-derived password.</span></span><br><span class="line"><span class="comment">// If efficiency was a major issue, just add in a UserCache implementation,</span></span><br><span class="line"><span class="comment">// but recall that this method is usually only called once per HttpSession - if</span></span><br><span class="line"><span class="comment">// the token is valid,</span></span><br><span class="line"><span class="comment">// it will cause SecurityContextHolder population, whilst if invalid, will cause</span></span><br><span class="line"><span class="comment">// the cookie to be cancelled.</span></span><br><span class="line">String expectedTokenSignature = makeTokenSignature(tokenExpiryTime,</span><br><span class="line">userDetails.getUsername(), userDetails.getPassword());</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!equals(expectedTokenSignature, cookieTokens[<span class="number">2</span>])) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> InvalidCookieException(<span class="string">"Cookie token[2] contained signature '"</span></span><br><span class="line">+ cookieTokens[<span class="number">2</span>] + <span class="string">"' but expected '"</span> + expectedTokenSignature + <span class="string">"'"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> userDetails;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•£åˆ—åŠ å¯†</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">makeTokenSignature</span><span class="params">(<span class="keyword">long</span> tokenExpiryTime, String username,</span></span></span><br><span class="line"><span class="function"><span class="params">String password)</span> </span>&#123;</span><br><span class="line">String data = username + <span class="string">":"</span> + tokenExpiryTime + <span class="string">":"</span> + password + <span class="string">":"</span> + getKey();</span><br><span class="line">MessageDigest digest;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">digest = MessageDigest.getInstance(<span class="string">"MD5"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No MD5 algorithm available!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> String(Hex.encode(digest.digest(data.getBytes())));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æˆåŠŸè¿‡å</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoginSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">Authentication successfulAuthentication)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">String username = retrieveUserName(successfulAuthentication);</span><br><span class="line">String password = retrievePassword(successfulAuthentication);</span><br><span class="line"></span><br><span class="line"><span class="comment">// If unable to find a username and password, just abort as</span></span><br><span class="line"><span class="comment">// TokenBasedRememberMeServices is</span></span><br><span class="line"><span class="comment">// unable to construct a valid token in this case.</span></span><br><span class="line"><span class="keyword">if</span> (!StringUtils.hasLength(username)) &#123;</span><br><span class="line">logger.debug(<span class="string">"Unable to retrieve username"</span>);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!StringUtils.hasLength(password)) &#123;</span><br><span class="line">UserDetails user = getUserDetailsService().loadUserByUsername(username);</span><br><span class="line">password = user.getPassword();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!StringUtils.hasLength(password)) &#123;</span><br><span class="line">logger.debug(<span class="string">"Unable to obtain password for user: "</span> + username);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> tokenLifetime = calculateLoginLifetime(request, successfulAuthentication);</span><br><span class="line"><span class="keyword">long</span> expiryTime = System.currentTimeMillis();</span><br><span class="line"><span class="comment">// SEC-949</span></span><br><span class="line">expiryTime += <span class="number">1000L</span> * (tokenLifetime &lt; <span class="number">0</span> ? TWO_WEEKS_S : tokenLifetime);</span><br><span class="line"></span><br><span class="line">String signatureValue = makeTokenSignature(expiryTime, username, password);</span><br><span class="line"></span><br><span class="line">setCookie(<span class="keyword">new</span> String[] &#123; username, Long.toString(expiryTime), signatureValue &#125;,</span><br><span class="line">tokenLifetime, request, response);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">logger.debug(<span class="string">"Added remember-me cookie for user '"</span> + username</span><br><span class="line">+ <span class="string">"', expiry: '"</span> + <span class="keyword">new</span> Date(expiryTime) + <span class="string">"'"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content:encoded>
      
      <comments>http://rongflag.github.io/posts/security6.html#disqus_thread</comments>
    </item>
    
    <item>
      <title>mybatis-pluså­¦ä¹ </title>
      <link>http://rongflag.github.io/posts/mybatis-plus.html</link>
      <guid>http://rongflag.github.io/posts/mybatis-plus.html</guid>
      <pubDate>Tue, 10 Dec 2019 04:00:00 GMT</pubDate>
      <description>
      
        &lt;h1 id=&quot;Hello&quot;&gt;&lt;a href=&quot;#Hello&quot; class=&quot;headerlink&quot; title=&quot;Hello&quot;&gt;&lt;/a&gt;Hello&lt;/h1&gt;&lt;p&gt;ä½ å¥½ä¸–ç•Œ&lt;/p&gt;
      
      </description>
      
      
      <content:encoded><![CDATA[<h1 id="Hello"><a href="#Hello" class="headerlink" title="Hello"></a>Hello</h1><p>ä½ å¥½ä¸–ç•Œ</p><a id="more"></a><p>å…¨æ–‡å†…å®¹</p>]]></content:encoded>
      
      <comments>http://rongflag.github.io/posts/mybatis-plus.html#disqus_thread</comments>
    </item>
    
    <item>
      <title>security(5)è‡ªå®šä¹‰è®¤è¯å®ç°éªŒè¯ç </title>
      <link>http://rongflag.github.io/posts/security5.html</link>
      <guid>http://rongflag.github.io/posts/security5.html</guid>
      <pubDate>Tue, 10 Dec 2019 03:23:00 GMT</pubDate>
      <description>
      
        &lt;h2 id=&quot;1-åŸºæœ¬ä»‹ç»&quot;&gt;&lt;a href=&quot;#1-åŸºæœ¬ä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;1. åŸºæœ¬ä»‹ç»&quot;&gt;&lt;/a&gt;1. åŸºæœ¬ä»‹ç»&lt;/h2&gt;&lt;p&gt;ä½ å¥½ä¸–ç•Œ&lt;/p&gt;
      
      </description>
      
      
      <content:encoded><![CDATA[<h2 id="1-åŸºæœ¬ä»‹ç»"><a href="#1-åŸºæœ¬ä»‹ç»" class="headerlink" title="1. åŸºæœ¬ä»‹ç»"></a>1. åŸºæœ¬ä»‹ç»</h2><p>ä½ å¥½ä¸–ç•Œ</p><a id="more"></a><p>å…¨æ–‡å†…å®¹</p><p>è¿™é‡Œä½¿ç”¨<strong>è‡ªå®šä¹‰è®¤è¯</strong>æ¥å®ç°éªŒè¯ç ï¼Œä¹Ÿå°±æ˜¯å®ç°Filterçš„å¦å¤–ä¸€ç§æ–¹å¼ï¼Œå…¶å®æˆ‘ä¹Ÿä¸å¤ªç†Ÿ:joy:,å°†å°±çœ‹å§ã€‚</p><p>[TOC]</p><p>åœ¨SecurityéªŒè¯å¯¹è±¡å…¶å®å°±æ˜¯ä¸»ä½“<strong>ï¼ˆPrincipalï¼‰</strong>ï¼Œä¸»ä½“åŒ…å«äº†æ‰€æœ‰èƒ½å¤Ÿç»è¿‡éªŒè¯è€Œè·å¾—ç³»ç»Ÿè®¿é—®æƒé™çš„ç”¨æˆ·ï¼Œè®¾å¤‡æˆ–è€…å…¶ä»–ç³»ç»Ÿã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Authentication</span> <span class="keyword">extends</span> <span class="title">Principal</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"><span class="comment">// ä¸»ä½“æƒé™åˆ—è¡¨</span></span><br><span class="line">Collection&lt;? extends GrantedAuthority&gt; getAuthorities();</span><br><span class="line"><span class="comment">// è·å–ä¸»ä½“å‡­è¯ é€šå¸¸ä¸ºç”¨æˆ·å¯†ç </span></span><br><span class="line"><span class="function">Object <span class="title">getCredentials</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// è·å–ä¸»ä½“æºå¸¦çš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line"><span class="function">Object <span class="title">getDetails</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// è·å–ä¸»ä½“ï¼Œé€šå¸¸æ˜¯ç”¨æˆ·å</span></span><br><span class="line"><span class="function">Object <span class="title">getPrincipal</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// ä¸»ä½“æ˜¯å¦éªŒè¯æˆåŠŸ</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isAuthenticated</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setAuthenticated</span><span class="params">(<span class="keyword">boolean</span> isAuthenticated)</span> <span class="keyword">throws</span> IllegalArgumentException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Authentication</span> <span class="keyword">extends</span> <span class="title">Principal</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"><span class="comment">// è·å¾—ä¸»ä½“æƒé™</span></span><br><span class="line">Collection&lt;? extends GrantedAuthority&gt; getAuthorities();</span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="function">Object <span class="title">getCredentials</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="function">Object <span class="title">getDetails</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="function">Object <span class="title">getPrincipal</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isAuthenticated</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setAuthenticated</span><span class="params">(<span class="keyword">boolean</span> isAuthenticated)</span> <span class="keyword">throws</span> IllegalArgumentException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AuthenticationProvider æ˜¯Securityçš„ä¸€ä¸ªéªŒè¯è¿‡ç¨‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AuthenticationProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// éªŒè¯è¿‡ç¨‹ æˆåŠŸè¿”å›ä¸€ä¸ªéªŒè¯å®ŒæˆAuthentication</span></span><br><span class="line"><span class="function">Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> AuthenticationException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ˜¯å¦æ”¯æŒéªŒè¯å½“å‰çš„Authenticationç±»å‹</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; authentication)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éªŒè¯AuthenticationProvideræ˜¯é ProviderManageræ¥ç®¡ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderManager</span> <span class="keyword">implements</span> <span class="title">AuthenticationManager</span>, <span class="title">MessageSourceAware</span>,</span></span><br><span class="line"><span class="class"><span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">=====================================================================================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> AuthenticationEventPublisher eventPublisher = <span class="keyword">new</span> NullEventPublisher();</span><br><span class="line">     <span class="comment">// å¤šä¸ªéªŒè¯çš„è¿‡ç¨‹</span></span><br><span class="line"><span class="keyword">private</span> List&lt;AuthenticationProvider&gt; providers = Collections.emptyList();</span><br><span class="line"><span class="keyword">protected</span> MessageSourceAccessor messages = SpringSecurityMessageSource.getAccessor();</span><br><span class="line"><span class="keyword">private</span> AuthenticationManager parent;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> eraseCredentialsAfterAuthentication = <span class="keyword">true</span>;</span><br><span class="line">==============================================</span><br><span class="line"><span class="comment">// éªŒè¯çš„è¿‡ç¨‹</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">Class&lt;? extends Authentication&gt; toTest = authentication.getClass();</span><br><span class="line">AuthenticationException lastException = <span class="keyword">null</span>;</span><br><span class="line">AuthenticationException parentException = <span class="keyword">null</span>;</span><br><span class="line">Authentication result = <span class="keyword">null</span>;</span><br><span class="line">Authentication parentResult = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">boolean</span> debug = logger.isDebugEnabled();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (AuthenticationProvider provider : getProviders()) &#123;</span><br><span class="line"><span class="keyword">if</span> (!provider.supports(toTest)) &#123;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// éªŒè¯é€šè¿‡å°±è·³å‡ºå¾ªç¯</span></span><br><span class="line">result = provider.authenticate(authentication);</span><br><span class="line"><span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">copyDetails(authentication, result);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (AccountStatusException | InternalAuthenticationServiceException e) &#123;</span><br><span class="line">prepareException(e, authentication);</span><br><span class="line"><span class="comment">// SEC-546: Avoid polling additional providers if auth failure is due to</span></span><br><span class="line"><span class="comment">// invalid account status</span></span><br><span class="line"><span class="keyword">throw</span> e;</span><br><span class="line">&#125; <span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">lastException = e;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (result == <span class="keyword">null</span> &amp;&amp; parent != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">// Allow the parent to try.</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">result = parentResult = parent.authenticate(authentication);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (ProviderNotFoundException e) &#123;</span><br><span class="line"><span class="comment">// ignore as we will throw below if no other exception occurred prior to</span></span><br><span class="line"><span class="comment">// calling parent and the parent</span></span><br><span class="line"><span class="comment">// may throw ProviderNotFound even though a provider in the child already</span></span><br><span class="line"><span class="comment">// handled the request</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">lastException = parentException = e;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (eraseCredentialsAfterAuthentication</span><br><span class="line">&amp;&amp; (result <span class="keyword">instanceof</span> CredentialsContainer)) &#123;</span><br><span class="line"><span class="comment">// Authentication is complete. Remove credentials and other secret data</span></span><br><span class="line"><span class="comment">// from authentication</span></span><br><span class="line">((CredentialsContainer) result).eraseCredentials();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If the parent AuthenticationManager was attempted and successful than it will publish an AuthenticationSuccessEvent</span></span><br><span class="line"><span class="comment">// This check prevents a duplicate AuthenticationSuccessEvent if the parent AuthenticationManager already published it</span></span><br><span class="line"><span class="keyword">if</span> (parentResult == <span class="keyword">null</span>) &#123;</span><br><span class="line">eventPublisher.publishAuthenticationSuccess(result);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Parent was null, or didn't authenticate (or throw an exception).</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (lastException == <span class="keyword">null</span>) &#123;</span><br><span class="line">lastException = <span class="keyword">new</span> ProviderNotFoundException(messages.getMessage(</span><br><span class="line"><span class="string">"ProviderManager.providerNotFound"</span>,</span><br><span class="line"><span class="keyword">new</span> Object[] &#123; toTest.getName() &#125;,</span><br><span class="line"><span class="string">"No AuthenticationProvider found for &#123;0&#125;"</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If the parent AuthenticationManager was attempted and failed than it will publish an AbstractAuthenticationFailureEvent</span></span><br><span class="line"><span class="comment">// This check prevents a duplicate AbstractAuthenticationFailureEvent if the parent AuthenticationManager already published it</span></span><br><span class="line"><span class="keyword">if</span> (parentException == <span class="keyword">null</span>) &#123;</span><br><span class="line">prepareException(lastException, authentication);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">throw</span> lastException;</span><br><span class="line">&#125;</span><br><span class="line">=====================================================</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-AuthenticationProvider"><a href="#2-AuthenticationProvider" class="headerlink" title="2.AuthenticationProvider"></a>2.AuthenticationProvider</h2><p>éªŒè¯å…¶å®å°±æ˜¯AuthenticationProviderï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦è‡ªå®šä¹‰éªŒè¯ã€‚å…¶ä¸­Securityï¼ŒåŒ…å«äº†åŸºæœ¬çš„å‡ ç§ï¼š</p><ol><li>HTTPå±‚é¢çš„è®¤è¯æŠ€æœ¯ï¼ŒåŒ…æ‹¬HTTPåŸºæœ¬è®¤è¯å’ŒHTTPæ‘˜è¦è®¤è¯</li><li>åŸºäºLDAPçš„è®¤è¯æŠ€æœ¯</li><li>èšç„¦äºè¯æ˜ç”¨æˆ·èº«ä»½çš„OpenIDè®¤è¯æŠ€æœ¯</li><li>èšç„¦äºæˆæƒçš„OAuthè®¤è¯æŠ€æœ¯</li><li>ç³»ç»Ÿå†…ç»´æŠ¤çš„ç”¨æˆ·åå’Œå¯†ç è®¤è¯æŠ€æœ¯</li></ol><p>å…¶ä¸­æœ€å¹¿æ³›çš„çš„å°±æ˜¯<strong>ç³»ç»Ÿå†…ç»´æŠ¤çš„ç”¨æˆ·åå’Œå¯†ç è®¤è¯æŠ€æœ¯</strong>ï¼Œè¿™é‡Œå› ä¸ºéœ€è¦å’Œæ•°æ®åº“äº¤äº’ï¼ŒSecurityæä¾›äº†ä¸€ä¸ªæŠ½è±¡çš„AuthenticationProvider,<strong>AbstractUserDetailsAuthenticationProvider</strong>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractUserDetailsAuthenticationProvider</span> <span class="keyword">implements</span></span></span><br><span class="line"><span class="class"><span class="title">AuthenticationProvider</span>, <span class="title">InitializingBean</span>, <span class="title">MessageSourceAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é™„åŠ è®¤è¯è¿‡ç¨‹ -- æ ¸å¿ƒæ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">additionalAuthenticationChecks</span><span class="params">(UserDetails userDetails,</span></span></span><br><span class="line"><span class="function"><span class="params">UsernamePasswordAuthenticationToken authentication)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> AuthenticationException</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¤è¯è¿‡ç¨‹</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">Assert.isInstanceOf(UsernamePasswordAuthenticationToken<span class="class">.<span class="keyword">class</span>, <span class="title">authentication</span>,</span></span><br><span class="line"><span class="class">() -&gt; <span class="title">messages</span>.<span class="title">getMessage</span>(</span></span><br><span class="line">"AbstractUserDetailsAuthenticationProvider.onlySupports",</span><br><span class="line"><span class="string">"Only UsernamePasswordAuthenticationToken is supported"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Determine username</span></span><br><span class="line">String username = (authentication.getPrincipal() == <span class="keyword">null</span>) ? <span class="string">"NONE_PROVIDED"</span></span><br><span class="line">: authentication.getName();</span><br><span class="line"></span><br><span class="line"><span class="keyword">boolean</span> cacheWasUsed = <span class="keyword">true</span>;</span><br><span class="line">UserDetails user = <span class="keyword">this</span>.userCache.getUserFromCache(username);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">cacheWasUsed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// å…ˆæ£€ç´¢ç”¨æˆ·</span></span><br><span class="line">user = retrieveUser(username,</span><br><span class="line">(UsernamePasswordAuthenticationToken) authentication);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (UsernameNotFoundException notFound) &#123;</span><br><span class="line">logger.debug(<span class="string">"User '"</span> + username + <span class="string">"' not found"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (hideUserNotFoundExceptions) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> BadCredentialsException(messages.getMessage(</span><br><span class="line"><span class="string">"AbstractUserDetailsAuthenticationProvider.badCredentials"</span>,</span><br><span class="line"><span class="string">"Bad credentials"</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">throw</span> notFound;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Assert.notNull(user,</span><br><span class="line"><span class="string">"retrieveUser returned null - a violation of the interface contract"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ£€æŸ¥ç”¨æˆ·è´¦æˆ·æ˜¯å¦å¯ç”¨</span></span><br><span class="line">preAuthenticationChecks.check(user);</span><br><span class="line">            <span class="comment">// é™„åŠ è®¤è¯</span></span><br><span class="line">additionalAuthenticationChecks(user,</span><br><span class="line">(UsernamePasswordAuthenticationToken) authentication);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (AuthenticationException exception) &#123;</span><br><span class="line"><span class="keyword">if</span> (cacheWasUsed) &#123;</span><br><span class="line"><span class="comment">// There was a problem, so try again after checking</span></span><br><span class="line"><span class="comment">// we're using latest data (i.e. not from the cache)</span></span><br><span class="line">cacheWasUsed = <span class="keyword">false</span>;</span><br><span class="line">user = retrieveUser(username,</span><br><span class="line">(UsernamePasswordAuthenticationToken) authentication);</span><br><span class="line">preAuthenticationChecks.check(user);</span><br><span class="line">additionalAuthenticationChecks(user,</span><br><span class="line">(UsernamePasswordAuthenticationToken) authentication);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">throw</span> exception;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ£€æŸ¥ç”¨æˆ·å¯†ç æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">postAuthenticationChecks.check(user);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!cacheWasUsed) &#123;</span><br><span class="line"><span class="keyword">this</span>.userCache.putUserInCache(user);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Object principalToReturn = user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (forcePrincipalAsString) &#123;</span><br><span class="line">principalToReturn = user.getUsername();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è¿”å›ä¸€ä¸ªè®¤è¯é€šè¿‡çš„Authentication</span></span><br><span class="line"><span class="keyword">return</span> createSuccessAuthentication(principalToReturn, authentication, user);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€ç´¢ç”¨æˆ· ï¼ˆæ ¸å¿ƒæ–¹æ³•ï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> UserDetails <span class="title">retrieveUser</span><span class="params">(String username,</span></span></span><br><span class="line"><span class="function"><span class="params">UsernamePasswordAuthenticationToken authentication)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> AuthenticationException</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ­¤è®¤è¯è¿‡ç¨‹æ”¯æŒUsernamePasswordAuthenticationTokenåŠè¡ç”Ÿå¯¹è±¡</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; authentication)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> (UsernamePasswordAuthenticationToken<span class="class">.<span class="keyword">class</span></span></span><br><span class="line"><span class="class">.<span class="title">isAssignableFrom</span>(<span class="title">authentication</span>))</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„å®ç°ç±»<strong>DaoAuthenticationProvider</strong>ï¼Œä¸»è¦å®ç°äº†å¯†ç çš„ç¼–ç </p><h2 id="3-å®é™…ç¼–ç "><a href="#3-å®é™…ç¼–ç " class="headerlink" title="3.å®é™…ç¼–ç "></a>3.å®é™…ç¼–ç </h2><p>å› ä¸ºè¿™ä¸ªæˆ‘ä»¬éœ€è¦HttpRequest  æ‰€ä»¥éœ€è¦<strong>MyWebAuthenticationDetailsSource</strong>ï¼Œç„¶åè¡¥å……åˆ°<strong>MyWebAuthenticationDetails</strong>å®é™…éªŒè¯éªŒè¯ç ï¼Œæœ€åé€šè¿‡<strong>MyAuthenticationProvider</strong>ä¹Ÿå°±<strong>DaoAuthenticationProvider</strong>æ¥æ‰§è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAuthenticationProvider</span> <span class="keyword">extends</span> <span class="title">DaoAuthenticationProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€ æ–¹æ³•æ³¨å…¥UserDetailServiceå’ŒPasswordEncoder</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyAuthenticationProvider</span><span class="params">(UserDetailsService userDetailsService, PasswordEncoder passwordEncoder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setUserDetailsService(userDetailsService);</span><br><span class="line">        <span class="keyword">this</span>.setPasswordEncoder(passwordEncoder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">additionalAuthenticationChecks</span><span class="params">(UserDetails userDetails, UsernamePasswordAuthenticationToken usernamePasswordAuthenticationToken)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        MyWebAuthenticationDetails details = (MyWebAuthenticationDetails) usernamePasswordAuthenticationToken.getDetails();</span><br><span class="line">        <span class="comment">// éªŒè¯ç éªŒè¯é€»è¾‘</span></span><br><span class="line">        String imageCode = details.getImageCode();</span><br><span class="line">        String savedImageCode = details.getSavedImageCode();</span><br><span class="line">        <span class="comment">// æ£€éªŒå›¾å½¢éªŒè¯ç </span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(imageCode) || StringUtils.isEmpty(savedImageCode) || !imageCode.equals(savedImageCode)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> VerificationCodeException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è°ƒç”¨çˆ¶ç±»è¿›è¡Œå¯†ç éªŒè¯</span></span><br><span class="line">        <span class="keyword">super</span>.additionalAuthenticationChecks(userDetails, usernamePasswordAuthenticationToken);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWebAuthenticationDetails</span> <span class="keyword">extends</span> <span class="title">WebAuthenticationDetails</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String imageCode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String savedImageCode;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getImageCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> imageCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSavedImageCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> savedImageCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¡¥å……ç”¨æˆ·æäº¤çš„éªŒè¯ç å’Œsessionä¿å­˜çš„éªŒè¯ç </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyWebAuthenticationDetails</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(request);</span><br><span class="line">        <span class="keyword">this</span>.imageCode = request.getParameter(<span class="string">"captcha"</span>);</span><br><span class="line">        HttpSession session = request.getSession();</span><br><span class="line">        <span class="keyword">this</span>.savedImageCode = (String) session.getAttribute(<span class="string">"captcha"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(<span class="keyword">this</span>.savedImageCode)) &#123;</span><br><span class="line">            <span class="comment">// éšæ‰‹æ¸…é™¤éªŒè¯ç ï¼Œä¸ç®¡æ˜¯å¤±è´¥è¿˜æ˜¯æˆåŠŸï¼Œæ‰€ä»¥å®¢æˆ·ç«¯åº”åœ¨ç™»å½•å¤±è´¥æ—¶åˆ·æ–°éªŒè¯ç </span></span><br><span class="line">            session.removeAttribute(<span class="string">"captcha"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWebAuthenticationDetailsSource</span> <span class="keyword">implements</span> <span class="title">AuthenticationDetailsSource</span>&lt;<span class="title">HttpServletRequest</span>, <span class="title">WebAuthenticationDetails</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WebAuthenticationDetails <span class="title">buildDetails</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyWebAuthenticationDetails(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationDetailsSource&lt;HttpServletRequest, WebAuthenticationDetails&gt; myWebAuthenticationDetailsSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationProvider authenticationProvider;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// åº”ç”¨AuthenticationProvider</span></span><br><span class="line">        auth.authenticationProvider(authenticationProvider);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">"/admin/api/**"</span>).hasRole(<span class="string">"ADMIN"</span>)</span><br><span class="line">                .antMatchers(<span class="string">"/user/api/**"</span>).hasRole(<span class="string">"USER"</span>)</span><br><span class="line">                .antMatchers(<span class="string">"/app/api/**"</span>, <span class="string">"/captcha.jpg"</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .authenticationDetailsSource(myWebAuthenticationDetailsSource)</span><br><span class="line">                .failureHandler(<span class="keyword">new</span> SecurityAuthenticationFailureHandler())</span><br><span class="line">                .successHandler(<span class="keyword">new</span> SecurityAuthenticationSuccessHandler())</span><br><span class="line">                .loginPage(<span class="string">"/myLogin.html"</span>)</span><br><span class="line">                .loginProcessingUrl(<span class="string">"/login"</span>)</span><br><span class="line">                .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> NoOpPasswordEncoder.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä»–çš„ä»£ç å°±æ˜¯ä¸Šä¸€ç« çš„ä»£ç ã€‚</p><h2 id="4-å¯¹æ¯”ä¸€ä¸‹Filterå’ŒProvider"><a href="#4-å¯¹æ¯”ä¸€ä¸‹Filterå’ŒProvider" class="headerlink" title="4.å¯¹æ¯”ä¸€ä¸‹Filterå’ŒProvider"></a>4.å¯¹æ¯”ä¸€ä¸‹Filterå’ŒProvider</h2><p>å› ä¸ºæˆ‘ä»¬å¯†ç <strong>UsernamePasswordAuthenticationFilter</strong>æ˜¯Filterã€‚</p><p>Filter:</p><ol><li>è¿™ä¸ªæ˜¯Servletå±‚é¢çš„ï¼Œç®€å•æ˜“ç†è§£ï¼›</li><li>å¯è‡ªå®šä¹‰é¡ºåºï¼›</li></ol><p>Providerï¼š</p><p>â€‹    1.äº¤ç»™Securityæ¥æ§åˆ¶ï¼Œæ„Ÿè§‰æ›´ä¼˜é›…ï¼›</p><p>â€‹    2.é¡ºåºæ˜¯å¿…é¡»è¦æœ‰UserDetails,æ‰èƒ½ç»§ç»­ã€‚ï¼ˆä¸ªäººæš‚æ—¶ç†è§£ï¼Œä¸ç¡®å®šï¼‰</p><p>å¦‚æœæ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šè¦æ±‚è¿˜æ˜¯ç”¨<strong>Filter</strong>å§</p>]]></content:encoded>
      
      <comments>http://rongflag.github.io/posts/security5.html#disqus_thread</comments>
    </item>
    
    <item>
      <title>security(4)Filterå®ç°éªŒè¯ç </title>
      <link>http://rongflag.github.io/posts/security4.html</link>
      <guid>http://rongflag.github.io/posts/security4.html</guid>
      <pubDate>Mon, 09 Dec 2019 15:58:00 GMT</pubDate>
      <description>
      
        &lt;p&gt;ç”¨éªŒè¯å˜›æ¥&lt;/p&gt;
&lt;p&gt;è¿™ç« ä¸»è¦è¯´ä¸€ä¸‹securityçš„filterã€‚è¿™é‡Œä»¥éªŒè¯ç çš„filterä½œä¸ºå®ä¾‹è¿›è¡ŒéªŒè¯&lt;/p&gt;
&lt;p&gt;æœ‰çš„åªèƒ½é debugæ¥çœ‹é¡ºåº&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;æ–¹æ³•&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;addFilterBefore(filterA,filterB)&lt;/td&gt;
&lt;td&gt;æ·»åŠ Aåœ¨Båœ¨å‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;addFilter(filter)&lt;/td&gt;
&lt;td&gt;æ·»åŠ ä¸€ä¸ª&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;addFilterAfter(filterA,filterB)&lt;/td&gt;
&lt;td&gt;æ·»åŠ Aåœ¨Båœ¨å&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;addFilterAt()&lt;/td&gt;
&lt;td&gt;åœ¨åŒä¸€é¡ºåº&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
      
      </description>
      
      
      <content:encoded><![CDATA[<p>ç”¨éªŒè¯å˜›æ¥</p><p>è¿™ç« ä¸»è¦è¯´ä¸€ä¸‹securityçš„filterã€‚è¿™é‡Œä»¥éªŒè¯ç çš„filterä½œä¸ºå®ä¾‹è¿›è¡ŒéªŒè¯</p><p>æœ‰çš„åªèƒ½é debugæ¥çœ‹é¡ºåº</p><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>addFilterBefore(filterA,filterB)</td><td>æ·»åŠ Aåœ¨Båœ¨å‰</td></tr><tr><td>addFilter(filter)</td><td>æ·»åŠ ä¸€ä¸ª</td></tr><tr><td>addFilterAfter(filterA,filterB)</td><td>æ·»åŠ Aåœ¨Båœ¨å</td></tr><tr><td>addFilterAt()</td><td>åœ¨åŒä¸€é¡ºåº</td></tr></tbody></table><a id="more"></a><p>å…¨æ–‡å†…å®¹</p><p>pom.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.penggle<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kaptcha<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>kaptchaé…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CaptchaConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Producer <span class="title">captcha</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// é…ç½®å›¾å½¢éªŒè¯ç çš„åŸºæœ¬å‚æ•°</span></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        <span class="comment">// å›¾ç‰‡å®½åº¦</span></span><br><span class="line">        properties.setProperty(<span class="string">"kaptcha.image.width"</span>, <span class="string">"150"</span>);</span><br><span class="line">        <span class="comment">// å›¾ç‰‡é•¿åº¦</span></span><br><span class="line">        properties.setProperty(<span class="string">"kaptcha.image.height"</span>, <span class="string">"50"</span>);</span><br><span class="line">        <span class="comment">// å­—ç¬¦é›†</span></span><br><span class="line">        properties.setProperty(<span class="string">"kaptcha.textproducer.char.string"</span>, <span class="string">"0123456789"</span>);</span><br><span class="line">        <span class="comment">// å­—ç¬¦é•¿åº¦</span></span><br><span class="line">        properties.setProperty(<span class="string">"kaptcha.textproducer.char.length"</span>, <span class="string">"4"</span>);</span><br><span class="line">        Config config = <span class="keyword">new</span> Config(properties);</span><br><span class="line">        <span class="comment">// ä½¿ç”¨é»˜è®¤çš„å›¾å½¢éªŒè¯ç å®ç°ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è‡ªå®šä¹‰å®ç°</span></span><br><span class="line">        DefaultKaptcha defaultKaptcha = <span class="keyword">new</span> DefaultKaptcha();</span><br><span class="line">        defaultKaptcha.setConfig(config);</span><br><span class="line">        <span class="keyword">return</span> defaultKaptcha;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CaptchaController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Producer captchaProducer;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/captcha.jpg"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getCaptcha</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®å†…å®¹ç±»å‹</span></span><br><span class="line">        response.setContentType(<span class="string">"image/jpeg"</span>);</span><br><span class="line">        <span class="comment">// åˆ›å»ºéªŒè¯ç æ–‡æœ¬</span></span><br><span class="line">        String capText = captchaProducer.createText();</span><br><span class="line">        <span class="comment">// å°†éªŒè¯ç æ–‡æœ¬è®¾ç½®åˆ°session</span></span><br><span class="line">        request.getSession().setAttribute(<span class="string">"captcha"</span>, capText);</span><br><span class="line">        <span class="comment">// åˆ›å»ºéªŒè¯ç å›¾ç‰‡</span></span><br><span class="line">        BufferedImage bi = captchaProducer.createImage(capText);</span><br><span class="line">        <span class="comment">// è·å–å“åº”è¾“å‡ºæµ</span></span><br><span class="line">        ServletOutputStream out = response.getOutputStream();</span><br><span class="line">        <span class="comment">// å°†å›¾ç‰‡éªŒè¯ç æ•°æ®å†™åˆ°å“åº”è¾“å‡ºæµ</span></span><br><span class="line">        ImageIO.write(bi, <span class="string">"jpg"</span>, out);</span><br><span class="line">        <span class="comment">// æ¨é€å¹¶å…³é—­å“åº”è¾“å‡ºæµ</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            out.flush();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            out.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>filter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VerificationCodeFilter</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AuthenticationFailureHandler authenticationFailureHandler = <span class="keyword">new</span> SecurityAuthenticationFailureHandler();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="comment">// éç™»å½•è¯·æ±‚ä¸æ ¡éªŒéªŒè¯ç </span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">"/login"</span>.equals(httpServletRequest.getRequestURI())) &#123;</span><br><span class="line">            filterChain.doFilter(httpServletRequest, httpServletResponse);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                verificationCode(httpServletRequest);</span><br><span class="line">                filterChain.doFilter(httpServletRequest, httpServletResponse);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (VerificationCodeException e) &#123;</span><br><span class="line">                authenticationFailureHandler.onAuthenticationFailure(httpServletRequest, httpServletResponse, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">verificationCode</span> <span class="params">(HttpServletRequest httpServletRequest)</span> <span class="keyword">throws</span> VerificationCodeException </span>&#123;</span><br><span class="line">        String requestCode = httpServletRequest.getParameter(<span class="string">"captcha"</span>);</span><br><span class="line">        HttpSession session = httpServletRequest.getSession();</span><br><span class="line">        String savedCode = (String) session.getAttribute(<span class="string">"captcha"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(savedCode)) &#123;</span><br><span class="line">            <span class="comment">// éšæ‰‹æ¸…é™¤éªŒè¯ç ï¼Œä¸ç®¡æ˜¯å¤±è´¥è¿˜æ˜¯æˆåŠŸï¼Œæ‰€ä»¥å®¢æˆ·ç«¯åº”åœ¨ç™»å½•å¤±è´¥æ—¶åˆ·æ–°éªŒè¯ç </span></span><br><span class="line">            session.removeAttribute(<span class="string">"captcha"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ ¡éªŒä¸é€šè¿‡æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(requestCode) || StringUtils.isEmpty(savedCode) || !requestCode.equals(savedCode)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> VerificationCodeException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Security</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">"/admin/**"</span>).hasRole(<span class="string">"admin"</span>)</span><br><span class="line">                .antMatchers(<span class="string">"/user/**"</span>).hasRole(<span class="string">"user"</span>)</span><br><span class="line">                .antMatchers(<span class="string">"/api/**"</span>).permitAll()</span><br><span class="line">                .antMatchers(<span class="string">"/captcha.jpg"</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .loginPage(<span class="string">"/myLogin.html"</span>)</span><br><span class="line">                .loginProcessingUrl(<span class="string">"/login"</span>)</span><br><span class="line">                .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">                .cors().and().csrf().disable();</span><br><span class="line"></span><br><span class="line">        http.addFilterBefore(<span class="keyword">new</span> VerificationCodeFilter(),UsernamePasswordAuthenticationFilter<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//        http.addFilter()</span></span><br><span class="line"><span class="comment">//        http.addFilterAfter()</span></span><br><span class="line"><span class="comment">//        http.addFilterA</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> NoOpPasswordEncoder.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"login"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Acced Form<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"login-top"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h1</span>&gt;</span>LOGIN FORM<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/login"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">placeholder</span>=<span class="string">"username"</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">placeholder</span>=<span class="string">"password"</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"display: flex;"</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- æ–°å¢å›¾å½¢éªŒè¯ç çš„è¾“å…¥æ¡† --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"captcha"</span> <span class="attr">placeholder</span>=<span class="string">"captcha"</span> /&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- å›¾ç‰‡æŒ‡å‘å›¾å½¢éªŒè¯ç API --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/captcha.jpg"</span> <span class="attr">alt</span>=<span class="string">"captcha"</span> <span class="attr">height</span>=<span class="string">"50px"</span> <span class="attr">width</span>=<span class="string">"150px"</span> <span class="attr">style</span>=<span class="string">"margin-left: 20px;"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"forgot"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>forgot Password<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Login"</span> &gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"login-bottom"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h3</span>&gt;</span>New User <span class="symbol">&amp;nbsp;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>Register<span class="tag">&lt;/<span class="name">a</span>&gt;</span>&amp;nbsp Here<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content:encoded>
      
      <comments>http://rongflag.github.io/posts/security4.html#disqus_thread</comments>
    </item>
    
    <item>
      <title>ç•ªå¤–ç¯‡HttpSecurityé…ç½®æ„æ€</title>
      <link>http://rongflag.github.io/posts/security_f1.html</link>
      <guid>http://rongflag.github.io/posts/security_f1.html</guid>
      <pubDate>Sun, 08 Dec 2019 07:14:23 GMT</pubDate>
      <description>
      
        &lt;p&gt;Securityç•ªå¤–ç¯‡&lt;/p&gt;
&lt;p&gt;è¿™ç¯‡ä¸»è¦è¯´çš„æ˜¯ HttpSecurityå„ç§é…ç½®çš„æ–¹æ³•åŠæ„ä¹‰ã€‚è¿™ä¸ªç”¨åˆ°å“ªé‡Œå°±ä¼šè¯´åˆ°å“ªé‡Œ&lt;/p&gt;
      
      </description>
      
      
      <content:encoded><![CDATA[<p>Securityç•ªå¤–ç¯‡</p><p>è¿™ç¯‡ä¸»è¦è¯´çš„æ˜¯ HttpSecurityå„ç§é…ç½®çš„æ–¹æ³•åŠæ„ä¹‰ã€‚è¿™ä¸ªç”¨åˆ°å“ªé‡Œå°±ä¼šè¯´åˆ°å“ªé‡Œ</p><a id="more"></a><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">http.authorizeRequests()</span><br><span class="line">               .antMatchers(<span class="string">"/admin/api/**"</span>).hasIpAddress(<span class="string">""</span>)</span><br><span class="line">               .antMatchers(<span class="string">"/admin/api/**"</span>).hasRole(<span class="string">"admin"</span>)</span><br><span class="line">               .antMatchers(<span class="string">"/user/api/**"</span>).hasRole(<span class="string">"user"</span>)</span><br><span class="line">               .antMatchers(<span class="string">"/app/api/**"</span>, <span class="string">"/captcha.jpg"</span>).permitAll()</span><br><span class="line">               .anyRequest().authenticated()</span><br><span class="line">               .and()</span><br><span class="line">               .formLogin()</span><br><span class="line">               .failureHandler(<span class="keyword">new</span> SecurityAuthenticationFailureHandler())</span><br><span class="line">               .successHandler(<span class="keyword">new</span> SecurityAuthenticationSuccessHandler())</span><br><span class="line">               .loginPage(<span class="string">"/myLogin.html"</span>)</span><br><span class="line">               .loginProcessingUrl(<span class="string">"/login"</span>)</span><br><span class="line">               .permitAll()</span><br><span class="line">               .and()</span><br><span class="line">               .csrf()</span><br><span class="line">               .disable();</span><br></pre></td></tr></table></figure><p>å…¶å®æˆ‘ä»¬éœ€è¦å¥½å¥½è€ƒè™‘ä¸€ä¸‹HttpSecurityé‚£ä¹ˆå¤šé…ç½®æ–¹æ³•åˆ°åº•ä»£è¡¨ä»€ä¹ˆæ„æ€ã€‚æˆ‘ä»¬ä¸€èµ·æ¥è¯´ä¸€ä¸‹å¸¸ç”¨çš„æ–¹æ³•å§ã€‚</p><table><thead><tr><th><strong>æ–¹æ³•</strong></th><th><strong>è¯´æ˜</strong></th><th>è¿”å›å€¼</th></tr></thead><tbody><tr><td><strong>openidLogin()</strong></td><td>ç”¨äºåŸºäº OpenId çš„éªŒè¯</td><td>OpenIDLoginConfigurer</td></tr><tr><td><strong>headers()</strong></td><td>å°†å®‰å…¨æ ‡å¤´æ·»åŠ åˆ°å“åº”</td><td></td></tr><tr><td><strong>cors()</strong></td><td>é…ç½®è·¨åŸŸèµ„æºå…±äº«ï¼ˆ CORS ï¼‰</td><td></td></tr><tr><td><strong>sessionManagement()</strong></td><td>å…è®¸é…ç½®ä¼šè¯ç®¡ç†</td><td></td></tr><tr><td><strong>portMapper()</strong></td><td>å…è®¸é…ç½®ä¸€ä¸ªPortMapper(HttpSecurity#(getSharedObject(class)))ï¼Œå…¶ä»–æä¾›SecurityConfigurerçš„å¯¹è±¡ä½¿ç”¨ PortMapper ä» HTTP é‡å®šå‘åˆ° HTTPS æˆ–è€…ä» HTTPS é‡å®šå‘åˆ° HTTPã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpring Securityä½¿ç”¨ä¸€ä¸ªPortMapperImplæ˜ å°„ HTTP ç«¯å£8080åˆ° HTTPS ç«¯å£8443ï¼ŒHTTP ç«¯å£80åˆ° HTTPS ç«¯å£443</td><td></td></tr><tr><td><strong>jee()</strong></td><td>é…ç½®åŸºäºå®¹å™¨çš„é¢„è®¤è¯ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè®¤è¯ç”±Servletå®¹å™¨ç®¡ç†</td><td></td></tr><tr><td><strong>x509()</strong></td><td>é…ç½®åŸºäºx509çš„è®¤è¯</td><td></td></tr><tr><td><strong>rememberMe</strong></td><td>å…è®¸é…ç½®â€œè®°ä½æˆ‘â€çš„éªŒè¯</td><td></td></tr><tr><td><a href="#authorizeRequests"><strong>authorizeRequests()</strong></a></td><td>å…è®¸åŸºäºä½¿ç”¨HttpServletRequesté™åˆ¶è®¿é—®</td><td></td></tr><tr><td><strong>requestCache()</strong></td><td>å…è®¸é…ç½®è¯·æ±‚ç¼“å­˜</td><td></td></tr><tr><td><strong>exceptionHandling()</strong></td><td>å…è®¸é…ç½®é”™è¯¯å¤„ç†</td><td></td></tr><tr><td><strong>securityContext()</strong></td><td>åœ¨HttpServletRequestsä¹‹é—´çš„SecurityContextHolderä¸Šè®¾ç½®SecurityContextçš„ç®¡ç†ã€‚ å½“ä½¿ç”¨WebSecurityConfigurerAdapteræ—¶ï¼Œè¿™å°†è‡ªåŠ¨åº”ç”¨</td><td></td></tr><tr><td><strong>servletApi()</strong></td><td>å°†HttpServletRequestæ–¹æ³•ä¸åœ¨å…¶ä¸Šæ‰¾åˆ°çš„å€¼é›†æˆåˆ°SecurityContextä¸­ã€‚ å½“ä½¿ç”¨WebSecurityConfigurerAdapteræ—¶ï¼Œè¿™å°†è‡ªåŠ¨åº”ç”¨</td><td></td></tr><tr><td><strong>csrf()</strong></td><td>æ·»åŠ  CSRF æ”¯æŒï¼Œä½¿ç”¨WebSecurityConfigurerAdapteræ—¶ï¼Œé»˜è®¤å¯ç”¨</td><td></td></tr><tr><td><strong>logout()</strong></td><td>æ·»åŠ é€€å‡ºç™»å½•æ”¯æŒã€‚å½“ä½¿ç”¨WebSecurityConfigurerAdapteræ—¶ï¼Œè¿™å°†è‡ªåŠ¨åº”ç”¨ã€‚é»˜è®¤æƒ…å†µæ˜¯ï¼Œè®¿é—®URLâ€/ logoutâ€ï¼Œä½¿HTTP Sessionæ— æ•ˆæ¥æ¸…é™¤ç”¨æˆ·ï¼Œæ¸…é™¤å·²é…ç½®çš„ä»»ä½•#rememberMe()èº«ä»½éªŒè¯ï¼Œæ¸…é™¤SecurityContextHolderï¼Œç„¶åé‡å®šå‘åˆ°â€/login?successâ€</td><td></td></tr><tr><td><strong>anonymous()</strong></td><td>å…è®¸é…ç½®åŒ¿åç”¨æˆ·çš„è¡¨ç¤ºæ–¹æ³•ã€‚ å½“ä¸WebSecurityConfigurerAdapterç»“åˆä½¿ç”¨æ—¶ï¼Œè¿™å°†è‡ªåŠ¨åº”ç”¨ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒåŒ¿åç”¨æˆ·å°†ä½¿ç”¨org.springframework.security.authentication.AnonymousAuthenticationTokenè¡¨ç¤ºï¼Œå¹¶åŒ…å«è§’è‰² â€œROLE_ANONYMOUSâ€</td><td></td></tr><tr><td><strong>formLogin()</strong></td><td>æŒ‡å®šæ”¯æŒåŸºäºè¡¨å•çš„èº«ä»½éªŒè¯ã€‚å¦‚æœæœªæŒ‡å®šFormLoginConfigurer#loginPage(String)ï¼Œåˆ™å°†ç”Ÿæˆé»˜è®¤ç™»å½•é¡µé¢</td><td></td></tr><tr><td><strong>oauth2Login()</strong></td><td>æ ¹æ®å¤–éƒ¨OAuth 2.0æˆ–OpenID Connect 1.0æä¾›ç¨‹åºé…ç½®èº«ä»½éªŒè¯</td><td></td></tr><tr><td><strong>requiresChannel()</strong></td><td>é…ç½®é€šé“å®‰å…¨ã€‚ä¸ºäº†ä½¿è¯¥é…ç½®æœ‰ç”¨ï¼Œå¿…é¡»æä¾›è‡³å°‘ä¸€ä¸ªåˆ°æ‰€éœ€ä¿¡é“çš„æ˜ å°„</td><td></td></tr><tr><td><strong>httpBasic()</strong></td><td>é…ç½® Http Basic éªŒè¯</td><td></td></tr><tr><td><strong>addFilterAt()</strong></td><td>åœ¨æŒ‡å®šçš„Filterç±»çš„ä½ç½®æ·»åŠ è¿‡æ»¤å™¨</td><td></td></tr><tr><td>and()</td><td>é‡æ–°è·å¾—HttpSercurity</td><td></td></tr><tr><td>permitAll()</td><td>ä¸å…è®¸åŒ¿åè®¿é—®ï¼Œä¸éœ€è¦æƒé™</td><td></td></tr></tbody></table><ol><li><p><a href="#authorizeRequests">authorizeRequests</a></p><p>è¿”å›å€¼ï¼š ExpressionInterceptUrlRegistry</p></li><li><p><a href="#formLogin">formLogin    </a>         </p><p>è¿”å›å€¼ FormLoginConfigurer</p></li><li><p><a href="#cors">cors</a>       </p><p>è¿”å›å€¼  CorsConfigurer</p></li><li><p>sessionManagement    </p><p>è¿”å›å€¼ SessionManagementConfigurer</p></li><li><p><a href="#httpBasic">httpBasic</a>        </p><p>è¿”å›å€¼ HttpBasicConfigurer</p></li><li><p>rememberMe                    </p><p>è¿”å›å€¼ RememberMeConfigurer</p></li><li><p><a href="#csrf">csrf</a></p><p>è¿”å›å€¼ CsrfConfigurer</p></li><li><p>jee() </p><p>è¿”å›å€¼ï¼šJeeConfigurer </p></li><li><p><a href="#logout">logout</a></p><p>è¿”å›å€¼ï¼š LogoutConfigurer</p></li><li><p>anonymous</p><p>è¿”å›å€¼ï¼šAnonymousConfigurer</p></li><li><p>exceptionHandling</p><p>è¿”å›å€¼ï¼šExceptionHandlingConfigurer</p></li><li><p>userDetailsService(UserDetailsService userDetailsService)</p><p>è¿”å›å€¼ï¼šHttpSecurity</p></li><li><p>servletApi</p><p>è¿”å›å€¼ï¼šServletApiConfigurer</p></li><li><p>x509() </p><p>è¿”å›å€¼ï¼šX509Configurer </p></li><li><p>openidLogin()</p><p>è¿”å›å€¼ï¼šOpenIDLoginConfigurer </p></li><li><p>requestCache </p><p>è¿”å›å€¼ï¼šRequestCacheConfigurer</p></li><li><p>headers() </p><p>è¿”å›å€¼ï¼šHeadersConfigurer </p></li><li><p>oauth2Login</p><p>è¿”å›å€¼ï¼šOAuth2LoginConfigurer</p></li><li><p>oauth2Client</p><p>è¿”å›å€¼ï¼šOAuth2ClientConfigurer</p></li><li><p>oauth2ResourceServer</p><p>è¿”å›å€¼ï¼šOAuth2ResourceServerConfigurer</p></li><li><p>requiresChannel</p><p>è¿”å›å€¼ï¼šChannelRequestMatcherRegistry</p></li><li><p>portMapper  </p><p>è¿”å›å€¼ï¼šPortMapperConfigurer </p></li><li><p>beforeConfigure</p><p>è¿”å›å€¼ï¼švoid</p></li><li><p>performBuild</p><p>è¿”å›å€¼ï¼šDefaultSecurityFilterChain</p></li><li><p>authenticationProvider</p><p>è¿”å›å€¼ï¼šHttpSecurity</p></li><li><p>securityContext </p><p>è¿”å›å€¼ï¼šSecurityContextConfigurer  </p></li><li><p>getAuthenticationRegistry</p><p>è¿”å›å€¼ï¼šAuthenticationManagerBuilder</p></li><li><p>addFilterAfter(Filter filter, Class&lt;? extends Filter&gt; afterFilter)</p><p>è¿”å›å€¼ï¼šHttpSecurity</p></li><li><p>addFilterBefore(Filter filter,Class&lt;? extends Filter&gt; beforeFilter)ã€</p><p>è¿”å›å€¼ï¼šHttpSecurity</p></li><li><p>addFilter(Filter filter)</p><p>è¿”å›å€¼ï¼šHttpSecurity</p></li><li><p>addFilterAt(Filter filter, Class&lt;? extends Filter&gt; atFilter)</p><p>è¿”å›å€¼ï¼šHttpSecurity</p></li><li><p>requestMatchersï¼ˆåŸºæœ¬ä¸ç›´æ¥ä½¿ç”¨ï¼‰</p><p>è¿”å›å€¼ RequestMatcherConfigurer</p></li><li><p>requestMatcher(RequestMatcher requestMatcher)ï¼ˆåŸºæœ¬ä¸ç›´æ¥ä½¿ç”¨ï¼‰</p><p>è¿”å›å€¼ï¼šHttpSecurity</p></li><li><p>antMatcher(String antPattern)ï¼ˆåŸºæœ¬ä¸ç›´æ¥ä½¿ç”¨ï¼‰</p><p>è¿”å›å€¼ï¼šHttpSecurity</p></li><li><p>mvcMatcher(String mvcPattern)ï¼ˆåŸºæœ¬ä¸ç›´æ¥ä½¿ç”¨ï¼‰</p><p>è¿”å›å€¼ï¼šHttpSecurity</p></li><li><p>regexMatcher(String pattern)ï¼ˆåŸºæœ¬ä¸ç›´æ¥ä½¿ç”¨ï¼‰</p><p>è¿”å›å€¼ï¼šHttpSecurity</p></li></ol><h2 id="1-authorizeRequests"><a href="#1-authorizeRequests" class="headerlink" title="1.authorizeRequests()"></a><a name="authorizeRequests">1.authorizeRequests()</a></h2><p>æ‰§è¡Œè¿™ä¸ªæ–¹æ³•åï¼Œä¸»è¦æ˜¯é…ç½®å„ç§è¯·æ±‚è·¯å¾„ï¼Œèµ„æºä¸æƒé™çš„å…³ç³»ï¼›</p><h3 id="1-é…ç½®è·¯å¾„"><a href="#1-é…ç½®è·¯å¾„" class="headerlink" title="1.é…ç½®è·¯å¾„"></a>1.é…ç½®è·¯å¾„</h3><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>anyRequest</td><td>æ‰€æœ‰è¯·æ±‚</td></tr><tr><td>antMatchers</td><td>é…ç½®è¯·æ±‚è·¯å¾„</td></tr><tr><td>mvcMatchers</td><td></td></tr><tr><td>regexMatchers</td><td></td></tr><tr><td>requestMatchers</td><td></td></tr></tbody></table><p>æ‰§è¡Œäº†è¿™ä¸ªæ–¹æ³•å…¶å®æ‰è·å¾—äº†ExpressionUrlAuthorizationConfigurerï¼Œä¸‹é¢æ˜¯ä»‹ç»ï¼š</p><blockquote><p>â€‹    Adds URL based authorization based upon SpEL expressions to an application. </p><p>â€‹    åŸºäºåº”ç”¨ç¨‹åºçš„SpELè¡¨è¾¾å¼çš„ddsåŸºäºURLçš„æˆæƒã€‚</p><p>At least one {@link org.springframework.web.bind.annotation.RequestMapping} needs to be mapped</p><p>to {@link ConfigAttribute}â€™s for this {@link SecurityContextConfigurer} to have meaning. </p><p>è‡³å°‘éœ€è¦æ˜ å°„ä¸€ä¸ªRequestMappingä½¿SecurityContextConfigurerå…·æœ‰ConfigAttributeæ„ä¹‰</p></blockquote><h3 id="2-é…ç½®æ‰€éœ€æƒé™æ“ä½œExpressionUrlAuthorizationConfigurer"><a href="#2-é…ç½®æ‰€éœ€æƒé™æ“ä½œExpressionUrlAuthorizationConfigurer" class="headerlink" title="2. é…ç½®æ‰€éœ€æƒé™æ“ä½œExpressionUrlAuthorizationConfigurer"></a>2. é…ç½®æ‰€éœ€æƒé™æ“ä½œExpressionUrlAuthorizationConfigurer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> String permitAll = <span class="string">"permitAll"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String denyAll = <span class="string">"denyAll"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String anonymous = <span class="string">"anonymous"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String authenticated = <span class="string">"authenticated"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String fullyAuthenticated = <span class="string">"fullyAuthenticated"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String rememberMe = <span class="string">"rememberMe"</span>;</span><br></pre></td></tr></table></figure><p>æ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.antMatchers(&quot;&#x2F;user&#x2F;api&#x2F;**&quot;).hasRole(&quot;user&quot;)</span><br><span class="line">.antMatchers(&quot;&#x2F;admin&#x2F;api&#x2F;**&quot;).hasIpAddress(&quot;&quot;)</span><br><span class="line">.antMatchers(&quot;&#x2F;app&#x2F;api&#x2F;**&quot;, &quot;&#x2F;captcha.jpg&quot;).permitAll() # æ”¾å¼ƒéªŒè¯ä½†æ˜¯å¿…é¡»è¦ç™»å½•</span><br><span class="line">.anyRequest().authenticated() # æ‰€æœ‰éªŒè¯</span><br></pre></td></tr></table></figure><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>hasAnyRole</td><td></td></tr><tr><td>hasRole</td><td></td></tr><tr><td>hasAuthority</td><td></td></tr><tr><td>hasAnyAuthority</td><td></td></tr><tr><td>hasIpAddress</td><td></td></tr><tr><td>authenticated</td><td></td></tr></tbody></table><h2 id="2-formLogin"><a href="#2-formLogin" class="headerlink" title="2.formLogin"></a>2.<a name="formLogin">formLogin</a></h2><p>é…ç½®æˆåŠŸ å¤±è´¥çš„è·¯å¾„å’Œé¡µé¢</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.failureHandler(<span class="keyword">new</span> SecurityAuthenticationFailureHandler())</span><br><span class="line">              .successHandler(<span class="keyword">new</span> SecurityAuthenticationSuccessHandler())</span><br><span class="line">              .loginPage(<span class="string">"/myLogin.html"</span>)</span><br><span class="line">              .loginProcessingUrl(<span class="string">"/login"</span>)</span><br><span class="line">              .defaultSuccessUrl(<span class="string">""</span>)</span><br><span class="line">              .authenticationDetailsSource(<span class="keyword">null</span>)</span><br><span class="line">              .failureForwardUrl(<span class="string">""</span>)</span><br><span class="line">              .failureUrl(<span class="string">""</span>)</span><br><span class="line">              .permitAll()</span><br></pre></td></tr></table></figure><h2 id="3-cors"><a href="#3-cors" class="headerlink" title="3. cors"></a>3. <a name="cors">cors</a></h2><p>è·¨åŸŸ</p><h2 id="5-httpBasic"><a href="#5-httpBasic" class="headerlink" title="5.httpBasic"></a>5.<a name="httpBasic">httpBasic</a></h2><p>asicèº«ä»½è®¤è¯ï¼Œæ˜¯HTTP 1.0ä¸­å¼•å…¥çš„è®¤è¯æ–¹æ¡ˆä¹‹ä¸€ã€‚è™½ç„¶æ–¹æ¡ˆæ¯”è¾ƒå¤è€ï¼ŒåŒæ—¶å­˜åœ¨å®‰å…¨ç¼ºé™·ï¼Œä½†ç”±äºå®ç°ç®€å•ï¼Œæ‰€ä»¥ä»æœ‰éƒ¨åˆ†åœºæ™¯ä¸‹åœ¨ä½¿ç”¨ï¼Œä¾‹å¦‚Tomcatè‡ªå¸¦çš„æœ‰ä¸ªmanageré¡¹ç›®ï¼Œè®¿é—®è¿™ä¸ªé¡¹ç›®éœ€è¦Basicè®¤è¯</p><p><strong>é»˜è®¤é¡µé¢å¼¹å‡ºä¸ªæ¡†</strong></p><h2 id="7-csrf"><a href="#7-csrf" class="headerlink" title="7.csrf"></a>7.<a name="csrf">csrf</a></h2><p>ç¦ç”¨csrf ä¿æŠ¤åŠŸèƒ½</p><h2 id="9-logout"><a href="#9-logout" class="headerlink" title="9.logout"></a>9.<a name="logout">logout</a></h2><p>é€€å‡ºé…ç½®  é»˜è®¤çš„æ˜¯â€œlogoutâ€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.addLogoutHandler(<span class="keyword">null</span>)</span><br><span class="line">               .clearAuthentication()</span><br><span class="line">               .deleteCookies()</span><br><span class="line">               .logoutRequestMatcher()</span><br><span class="line">               .logoutSuccessHandler()</span><br><span class="line">               .logoutSuccessUrl()</span><br><span class="line">               .logoutUrl()</span><br><span class="line">               .defaultLogoutSuccessHandlerFor()</span><br><span class="line">               .invalidateHttpSession()</span><br></pre></td></tr></table></figure>]]></content:encoded>
      
      <comments>http://rongflag.github.io/posts/security_f1.html#disqus_thread</comments>
    </item>
    
    <item>
      <title>securityï¼ˆ3ï¼‰è‡ªå®šä¹‰æ•°æ®åº“è®¤è¯ä¸æˆæƒ</title>
      <link>http://rongflag.github.io/posts/security3.html</link>
      <guid>http://rongflag.github.io/posts/security3.html</guid>
      <pubDate>Fri, 06 Dec 2019 15:12:00 GMT</pubDate>
      <description>
      
        &lt;p&gt;è¿™é‡Œä¼šé€šè¿‡è‡ªå®šä¹‰æ•°æ®åº“çš„æ–¹å¼æˆ–è€…ç”¨æˆ·ä¿¡æ¯ï¼Œæ¥è¿›è¡Œè®¤è¯ä¸æˆæƒ&lt;/p&gt;
      
      </description>
      
      
      <content:encoded><![CDATA[<p>è¿™é‡Œä¼šé€šè¿‡è‡ªå®šä¹‰æ•°æ®åº“çš„æ–¹å¼æˆ–è€…ç”¨æˆ·ä¿¡æ¯ï¼Œæ¥è¿›è¡Œè®¤è¯ä¸æˆæƒ</p><a id="more"></a><p>å…ˆåˆ›å»ºæ•°æ®åº“çš„è¡¨</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`security-study`</span>.<span class="string">`user2`</span>  (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">12</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`username`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`password`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`roles`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'å¤šä¸ªç”¨,éš”å¼€'</span>,</span><br><span class="line">  <span class="string">`enabled`</span> <span class="built_in">tinyint</span>(<span class="number">1</span>) <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">1</span> <span class="keyword">COMMENT</span> <span class="string">'1å¯ç”¨0ä¸å¯ç”¨'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4 <span class="keyword">COLLATE</span> = utf8mb4_0900_ai_ci ROW_FORMAT = Dynamic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`security-study`</span>.<span class="string">`users2`</span>(<span class="string">`id`</span>, <span class="string">`username`</span>, <span class="string">`password`</span>, <span class="string">`roles`</span>, <span class="string">`enabled`</span>) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">'admin'</span>, <span class="string">'123'</span>, <span class="string">'ROLE_admin,ROLE_user'</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`security-study`</span>.<span class="string">`users2`</span>(<span class="string">`id`</span>, <span class="string">`username`</span>, <span class="string">`password`</span>, <span class="string">`roles`</span>, <span class="string">`enabled`</span>) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">'user'</span>, <span class="string">'123'</span>, <span class="string">'ROLE_user'</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure><h2 id="1-åˆ›å»ºè‡ªå®šä¹‰UserDetails"><a href="#1-åˆ›å»ºè‡ªå®šä¹‰UserDetails" class="headerlink" title="1. åˆ›å»ºè‡ªå®šä¹‰UserDetails"></a>1. åˆ›å»ºè‡ªå®šä¹‰UserDetails</h2><p>Securityå…¶å®è¿‡ç¨‹çš„çš„ä¸­é—´ä»¶æ˜¯ UserDetails</p><p>UserDetailsæºç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDetails</span> <span class="keyword">extends</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    Collection&lt;? extends GrantedAuthority&gt; getAuthorities();</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">getPassword</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">getUsername</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAccountNonExpired</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAccountNonLocked</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isCredentialsNonExpired</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºUser   Userå®ç°UserDetails</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span>  <span class="keyword">implements</span> <span class="title">UserDetails</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> enabled;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String roles;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;GrantedAuthority&gt; authorities;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;GrantedAuthority&gt; <span class="title">getAuthorities</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.authorities;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAuthorities</span><span class="params">( List&lt;GrantedAuthority&gt; authorities)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.authorities = authorities;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccountNonExpired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccountNonLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCredentialsNonExpired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-åˆ›å»ºserviceå’Œmapper"><a href="#2-åˆ›å»ºserviceå’Œmapper" class="headerlink" title="2.åˆ›å»ºserviceå’Œmapper"></a>2.åˆ›å»ºserviceå’Œmapper</h2><blockquote><p>åŠ é…ç½® @MapperScan(â€œcom.rongflag.chapter3.mapperâ€)</p></blockquote><p>mapper</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UsersMapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"select * from users2 where username=#&#123;username&#125;"</span>)</span><br><span class="line">     <span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(@Param(<span class="string">"username"</span>)</span> String username)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>service</p><p>è¿™é‡Œéœ€è¦å®ç°UserDetailsService è®©sercurityä½¿ç”¨è¿™ä¸ªæ¥è¿›è¡Œè®¤è¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyUserDetailsService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UsersMapper usersMapper;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        User user = usersMapper.getUserByUsername(username);</span><br><span class="line">        <span class="keyword">if</span>(user == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UsernameNotFoundException(<span class="string">"æœªæ‰¾åˆ°è¯¥ç”¨æˆ·ï¼š"</span>+username);</span><br><span class="line">        &#125;</span><br><span class="line">        String roles = user.getRoles();</span><br><span class="line">        List&lt;GrantedAuthority&gt; grantedAuthorities = <span class="keyword">this</span>.createAuthorities(roles);</span><br><span class="line"><span class="comment">//        ç³»ç»Ÿè‡ªå¸¦çš„è½¬æ¢æƒé™ ä½†æ˜¯ç”¨è‡ªå·±çš„æ›´å¥½æ§åˆ¶</span></span><br><span class="line"><span class="comment">//        List&lt;GrantedAuthority&gt; grantedAuthorities = AuthorityUtils.commaSeparatedStringToAuthorityList(user.getRoles());</span></span><br><span class="line">        user.setAuthorities(grantedAuthorities);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Descripton</span> è‡ªè¡Œè½¬æ¢æƒé™</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@rerturn</span> </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span>  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@auther</span> aihuxi</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">      </span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;GrantedAuthority&gt; <span class="title">createAuthorities</span><span class="params">(String roles)</span> </span>&#123;</span><br><span class="line">        List&lt;GrantedAuthority&gt;lists = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span>(roles != <span class="keyword">null</span> &amp;&amp; !<span class="string">""</span>.equals(roles))&#123;</span><br><span class="line">            String[] roleArr = roles.split(<span class="string">","</span>);</span><br><span class="line">            <span class="keyword">for</span> (String role:roleArr )&#123;</span><br><span class="line">                lists.add(<span class="keyword">new</span> SimpleGrantedAuthority(role));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> lists;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-åˆ›å»ºsecurityå’Œcontroller"><a href="#3-åˆ›å»ºsecurityå’Œcontroller" class="headerlink" title="3.åˆ›å»ºsecurityå’Œcontroller"></a>3.åˆ›å»ºsecurityå’Œcontroller</h2><p>å’Œå‰é¢æ˜¯ä¸€æ ·çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span>(debug = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">"/admin/**"</span>).hasRole(<span class="string">"admin"</span>)</span><br><span class="line">                .antMatchers(<span class="string">"/user/**"</span>).hasRole(<span class="string">"user"</span>)</span><br><span class="line">                .antMatchers(<span class="string">"/api/**"</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">        ;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"user say hello"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"api"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"api say hello"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"admin"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdminController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"admin say hello"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±æŒ‰ç…§åŸæ¥çš„éªŒè¯å³å¯</p><h2 id="4-è¸©å‘è®°å½•"><a href="#4-è¸©å‘è®°å½•" class="headerlink" title="4.è¸©å‘è®°å½•"></a>4.è¸©å‘è®°å½•</h2><ol><li>é…ç½®éœ€è¦çš„æƒé™æ˜¯ â€œadminâ€,â€userâ€ ä½†æ˜¯æ•°æ®åº“åªèƒ½ä¿å­˜â€œROLE_adminâ€,â€ROLE_userâ€ï¼Œå¸¦æœ‰<strong>ROLE_</strong></li></ol><p>å› ä¸ºåœ¨securityConfigä¸­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.antMatchers(&quot;&#x2F;admin&#x2F;**&quot;).hasRole(&quot;admin&quot;)</span><br></pre></td></tr></table></figure><p>å¾€ä¸‹çœ‹æºç </p><p>org.springframework.security.config.annotation.web.configurers.ExpressionUrlAuthorizationConfigurer#hasRole</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">hasRole</span><span class="params">(String role)</span> </span>&#123;</span><br><span class="line">       Assert.notNull(role, <span class="string">"role cannot be null"</span>);</span><br><span class="line">       <span class="keyword">if</span> (role.startsWith(<span class="string">"ROLE_"</span>)) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"role should not start with 'ROLE_' since it is automatically inserted. Got '"</span> + role + <span class="string">"'"</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="string">"hasRole('ROLE_"</span> + role + <span class="string">"')"</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>å…¶å®ä¸Šä¸€ç« ä¹Ÿè¯´è¿‡äº†ï¼Œåœ¨è‡ªå·±åˆå§‹åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨æ–¹æ³• è‡ªåŠ¨åŠ ä¸Š <strong>ROLE_</strong></p><ol><li>enabled å­—æ®µçš„é—®é¢˜</li></ol><p>enabled æ˜¯securityéªŒè¯è‡ªå¸¦å­—æ®µ  1æ˜¯true 0æ˜¯false  </p><p>å…¶å®è‡ªå·±ä½¿ç”¨æœ€å¥½æ˜¯ä¸ä½¿ç”¨è¿™ä¸ªå­—æ®µï¼Œä¸å®¹æ˜“æ§åˆ¶</p><p>è¿™ä¸ªå­—æ®µä¹Ÿæ˜¯æˆ‘åœ¨è‡ªå·±è¯•çš„æ—¶å€™è¸©å‘å‡ºæ¥çš„</p>]]></content:encoded>
      
      <comments>http://rongflag.github.io/posts/security3.html#disqus_thread</comments>
    </item>
    
    <item>
      <title>securityï¼ˆ2ï¼‰åˆè¯†è®¤è¯ä¸æˆæƒ</title>
      <link>http://rongflag.github.io/posts/security2.html</link>
      <guid>http://rongflag.github.io/posts/security2.html</guid>
      <pubDate>Fri, 06 Dec 2019 14:04:00 GMT</pubDate>
      <description>
      
        &lt;p&gt;è¿™é‡Œä¼šåŸºç¡€çš„è§ä¸€ä¸‹è®¤è¯å’ŒæˆæƒåŸºäº&lt;strong&gt;å†…å­˜&lt;/strong&gt;å’Œ&lt;strong&gt;æ•°æ®åº“&lt;/strong&gt;&lt;/p&gt;
      
      </description>
      
      
      <content:encoded><![CDATA[<p>è¿™é‡Œä¼šåŸºç¡€çš„è§ä¸€ä¸‹è®¤è¯å’ŒæˆæƒåŸºäº<strong>å†…å­˜</strong>å’Œ<strong>æ•°æ®åº“</strong></p><a id="more"></a><p>pom.xml(ä¸ºäº†æ–¹ä¾¿å°±æŠŠæ•°æ®åº“é…ç½®ä¸€èµ·åŠ è¿›å»äº†)</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rongflag<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>chapter2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>chapter2<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>application.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc://localhost:3306/security-study?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false</span></span><br></pre></td></tr></table></figure><p>securityé…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span>(debug = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">"/admin/**"</span>).hasRole(<span class="string">"admin"</span>)</span><br><span class="line">                .antMatchers(<span class="string">"/user/**"</span>).hasRole(<span class="string">"user"</span>)</span><br><span class="line">                .antMatchers(<span class="string">"/api/**"</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">        ;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆå§‹åŒ–3ä¸ªcontroller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"user say hello"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"api"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"api say hello"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"admin"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdminController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"admin say hello"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-å†…å­˜"><a href="#1-å†…å­˜" class="headerlink" title="1.å†…å­˜"></a>1.å†…å­˜</h2><p>é€šè¿‡InMemoryUserDetailsManager å»æ„å»ºä¸¤ä¸ªäºº</p><table><thead><tr><th>ç”¨æˆ·å</th><th>å¯†ç </th><th>æƒé™</th></tr></thead><tbody><tr><td>user</td><td>123456</td><td>user</td></tr><tr><td>admin</td><td>123456</td><td>admin     user</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetailsService <span class="title">userDetailsService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        InMemoryUserDetailsManager manager = <span class="keyword">new</span> InMemoryUserDetailsManager();</span><br><span class="line">        manager.createUser(User.withUsername(<span class="string">"user"</span>).password(<span class="string">"123456"</span>).roles(<span class="string">"user"</span>).build());</span><br><span class="line">        manager.createUser(User.withUsername(<span class="string">"admin"</span>).password(<span class="string">"123456"</span>).roles(<span class="string">"user"</span>, <span class="string">"admin"</span>).build());</span><br><span class="line">        <span class="keyword">return</span> manager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> NoOpPasswordEncoder.getInstance();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å³å¯ä»¥é€šè¿‡ä¸åŒçš„urlå»éªŒè¯æƒé™æ˜¯å¦æˆåŠŸäº†ã€‚</p><h2 id="2-JDBC"><a href="#2-JDBC" class="headerlink" title="2.JDBC"></a>2.JDBC</h2><p>åˆ›å»ºä¸¤å¼ è¡¨ users authorities</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#96;security-study&#96;.&#96;users&#96;  (</span><br><span class="line">  &#96;username&#96; varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL,</span><br><span class="line">  &#96;password&#96; varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL DEFAULT NULL,</span><br><span class="line">  &#96;enabled&#96; tinyint(1) NULL DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;username&#96;) USING BTREE</span><br><span class="line">) ENGINE &#x3D; InnoDB CHARACTER SET &#x3D; utf8mb4 COLLATE &#x3D; utf8mb4_0900_ai_ci ROW_FORMAT &#x3D; Dynamic;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;security-study&#96;.&#96;authorities&#96;  (</span><br><span class="line">  &#96;username&#96; varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL,</span><br><span class="line">  &#96;authority&#96; varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL,</span><br><span class="line">  INDEX &#96;u_name&#96;(&#96;username&#96;) USING BTREE,</span><br><span class="line">  CONSTRAINT &#96;u_name&#96; FOREIGN KEY (&#96;username&#96;) REFERENCES &#96;security-study&#96;.&#96;users&#96; (&#96;username&#96;) ON DELETE RESTRICT ON UPDATE RESTRICT</span><br><span class="line">) ENGINE &#x3D; InnoDB CHARACTER SET &#x3D; utf8mb4 COLLATE &#x3D; utf8mb4_0900_ai_ci ROW_FORMAT &#x3D; Dynamic;</span><br></pre></td></tr></table></figure><p>å’Œä¸Šé¢åŸºæœ¬ç±»ä¼¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> UserDetailsService <span class="title">userDetailsService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      JdbcUserDetailsManager manager = <span class="keyword">new</span> JdbcUserDetailsManager();</span><br><span class="line">      manager.setDataSource(dataSource);</span><br><span class="line">      manager.createUser(User.withUsername(<span class="string">"user"</span>).password(<span class="string">"123"</span>).roles(<span class="string">"user"</span>).build());</span><br><span class="line">      manager.createUser(User.withUsername(<span class="string">"admin"</span>).password(<span class="string">"123"</span>).roles(<span class="string">"user"</span>, <span class="string">"admin"</span>).build());</span><br><span class="line">      <span class="keyword">return</span> manager;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨çš„æ—¶å€™è‡ªåŠ¨å°†æ„å»ºçš„æ•°æ®å‘users å’Œ authoritiesé‡Œé¢æ’å…¥  è¿™æ˜¯è‡ªåŠ¨çš„ä¸ç”¨æ‰‹åŠ ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`security-study`</span>.<span class="string">`users`</span>(<span class="string">`username`</span>, <span class="string">`password`</span>, <span class="string">`enabled`</span>) <span class="keyword">VALUES</span> (<span class="string">'user'</span>, <span class="string">'123'</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`security-study`</span>.<span class="string">`users`</span>(<span class="string">`username`</span>, <span class="string">`password`</span>, <span class="string">`enabled`</span>) <span class="keyword">VALUES</span> (<span class="string">'admin'</span>, <span class="string">'123'</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`security-study`</span>.<span class="string">`authorities`</span>(<span class="string">`username`</span>, <span class="string">`authority`</span>) <span class="keyword">VALUES</span> (<span class="string">'user'</span>, <span class="string">'ROLE_user'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`security-study`</span>.<span class="string">`authorities`</span>(<span class="string">`username`</span>, <span class="string">`authority`</span>) <span class="keyword">VALUES</span> (<span class="string">'admin'</span>, <span class="string">'ROLE_admin'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`security-study`</span>.<span class="string">`authorities`</span>(<span class="string">`username`</span>, <span class="string">`authority`</span>) <span class="keyword">VALUES</span> (<span class="string">'admin'</span>, <span class="string">'ROLE_user'</span>);</span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œé‡å¤å¯åŠ¨çš„æ—¶å€™æ•°æ®åº“æ•°æ®ä¸ä¼šåˆ é™¤ ä¼šæŠ¥é”™ éœ€è¦æŠŠæ•°æ®åº“ä¸­æ•°æ®æ¸…æ‰</p></blockquote><p>è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ è‡ªåŠ¨åŠ çš„æ—¶å€™ roleé‡Œé¢ä¼šè‡ªåŠ¨åŠ ä¸Š ROLE_  çœ‹æºç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> User.<span class="function">UserBuilder <span class="title">roles</span><span class="params">(String... roles)</span> </span>&#123;</span><br><span class="line">         List&lt;GrantedAuthority&gt; authorities = <span class="keyword">new</span> ArrayList(roles.length);</span><br><span class="line">         String[] var3 = roles;</span><br><span class="line">         <span class="keyword">int</span> var4 = roles.length;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">for</span>(<span class="keyword">int</span> var5 = <span class="number">0</span>; var5 &lt; var4; ++var5) &#123;</span><br><span class="line">             String role = var3[var5];</span><br><span class="line">             Assert.isTrue(!role.startsWith(<span class="string">"ROLE_"</span>), () -&gt; &#123;</span><br><span class="line">                 <span class="keyword">return</span> role + <span class="string">" cannot start with ROLE_ (it is automatically added)"</span>;</span><br><span class="line">             &#125;);</span><br><span class="line">             authorities.add(<span class="keyword">new</span> SimpleGrantedAuthority(<span class="string">"ROLE_"</span> + role));</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">this</span>.authorities((Collection)authorities);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure><p>å®éªŒæ–¹å¼å’Œä¸Šé¢ç±»ä¼¼</p>]]></content:encoded>
      
      <comments>http://rongflag.github.io/posts/security2.html#disqus_thread</comments>
    </item>
    
    <item>
      <title>security(1)åˆå§‹security</title>
      <link>http://rongflag.github.io/posts/security1.html</link>
      <guid>http://rongflag.github.io/posts/security1.html</guid>
      <pubDate>Thu, 05 Dec 2019 14:14:00 GMT</pubDate>
      <description>
      
        &lt;p&gt;securityåœ¨springcloudé‡Œé¢ä½¿ç”¨ä¼šå¥½ä¸€äº›ã€‚ç°åœ¨å°±ä»å¤´å¼€å§‹æ¥è¿›è¡Œsecurityå­¦ä¹ ä¸€éã€‚&lt;/p&gt;
      
      </description>
      
      
      <content:encoded><![CDATA[<p>securityåœ¨springcloudé‡Œé¢ä½¿ç”¨ä¼šå¥½ä¸€äº›ã€‚ç°åœ¨å°±ä»å¤´å¼€å§‹æ¥è¿›è¡Œsecurityå­¦ä¹ ä¸€éã€‚</p><a id="more"></a><h2 id="1-åˆ›å»ºé¡¹ç›®å¼•å…¥ä¾èµ–"><a href="#1-åˆ›å»ºé¡¹ç›®å¼•å…¥ä¾èµ–" class="headerlink" title="1. åˆ›å»ºé¡¹ç›®å¼•å…¥ä¾èµ–"></a>1. åˆ›å»ºé¡¹ç›®å¼•å…¥ä¾èµ–</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rongflag<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>security-book<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>securiyå­¦ä¹ <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="åšä¸ªå°æµ‹è¯•"><a href="#åšä¸ªå°æµ‹è¯•" class="headerlink" title="åšä¸ªå°æµ‹è¯•"></a>åšä¸ªå°æµ‹è¯•</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityBookApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">helloWord</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello security"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SecurityBookApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨çš„æ—¶å€™ åœ¨æ§åˆ¶å°ä¼šæœ‰</p><blockquote><p>Using generated security password: 873a219e-5a1c-4c25-8027-880fb484646e</p><p>é»˜è®¤ç”¨æˆ·åæ˜¯ user</p></blockquote><p>ç›´æ¥ç™»å½• localhost:8080  </p><p>ç™»å½• user å’Œå¯†ç å°±å¯ä»¥è¿›å…¥äº†</p><h2 id="2-è‡ªå®šä¹‰ç”¨æˆ·åå’Œå¯†ç "><a href="#2-è‡ªå®šä¹‰ç”¨æˆ·åå’Œå¯†ç " class="headerlink" title="2. è‡ªå®šä¹‰ç”¨æˆ·åå’Œå¯†ç "></a>2. è‡ªå®šä¹‰ç”¨æˆ·åå’Œå¯†ç </h2><p>åœ¨resouces/application.properties é…ç½®</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.security.user.name</span>=<span class="string">user</span></span><br><span class="line"><span class="meta">spring.security.user.password</span>=<span class="string">123456</span></span><br></pre></td></tr></table></figure><p>restart </p><p>è¿™æ ·è¿›å…¥localhost:8080 ç”¨æˆ·åå’Œå¯†ç å°±ä¿®æ”¹äº†</p><h2 id="3-è¡¨å•éªŒè¯"><a href="#3-è¡¨å•éªŒè¯" class="headerlink" title="3. è¡¨å•éªŒè¯"></a>3. è¡¨å•éªŒè¯</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨WebSecurityConfigurerAdapteré‡Œé¢</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.logger.debug(<span class="string">"Using default configure(HttpSecurity). If subclassed this will potentially override subclass configure(HttpSecurity)."</span>);</span><br><span class="line">         ((HttpSecurity)((HttpSecurity)((ExpressionUrlAuthorizationConfigurer.AuthorizedUrl)http</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .anyRequest())  <span class="comment">// éªŒè¯æ‰€æœ‰çš„è¯·æ±‚</span></span><br><span class="line">                .authenticated()</span><br><span class="line">                .and())</span><br><span class="line">                .formLogin() <span class="comment">// è¡¨å•éªŒè¯</span></span><br><span class="line">                .and())</span><br><span class="line">                .httpBasic(); <span class="comment">// å…è®¸ç”¨æˆ·ä½¿ç”¨httpåŸºæœ¬éªŒè¯</span></span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="4-è‡ªå®šä¹‰è¡¨å•ç™»å½•é¡µ"><a href="#4-è‡ªå®šä¹‰è¡¨å•ç™»å½•é¡µ" class="headerlink" title="4. è‡ªå®šä¹‰è¡¨å•ç™»å½•é¡µ"></a>4. è‡ªå®šä¹‰è¡¨å•ç™»å½•é¡µ</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .anyRequest()</span><br><span class="line">                .authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .loginPage(<span class="string">"/myLogin.html"</span>) <span class="comment">// ç™»å½•é¡µ</span></span><br><span class="line">                .loginProcessingUrl(<span class="string">"/login"</span>)<span class="comment">// ç™»å½•è·¯å¾„</span></span><br><span class="line">                .permitAll()</span><br><span class="line">                .and().csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¡µé¢</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"login"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Acced Form<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"login-top"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>LOGIN FORM<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/login"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">placeholder</span>=<span class="string">"username"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">placeholder</span>=<span class="string">"password"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"forgot"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>forgot Password<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Login"</span> &gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"login-bottom"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>New User <span class="symbol">&amp;nbsp;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>Register<span class="tag">&lt;/<span class="name">a</span>&gt;</span>&amp;nbsp Here<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·ç™»å½• å°±å¯ä»¥äº†</p><h2 id="5-å…¶ä»–é…ç½®"><a href="#5-å…¶ä»–é…ç½®" class="headerlink" title="5.å…¶ä»–é…ç½®"></a>5.å…¶ä»–é…ç½®</h2><p>æ¯”å¦‚æˆåŠŸè¿‡å æˆ–è€…å¤±è´¥çš„ä¸€äº›æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .loginPage(<span class="string">"/myLogin.html"</span>)</span><br><span class="line">                .loginProcessingUrl(<span class="string">"/login"</span>)</span><br><span class="line">                .successHandler(<span class="keyword">new</span> AuthenticationSuccessHandler() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAuthenticationSuccess</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">                        httpServletResponse.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">                        PrintWriter out = httpServletResponse.getWriter();</span><br><span class="line">                        out.write(<span class="string">"&#123;\"error_code\":\"0\", \"message\":\"æ¬¢è¿ç™»å½•ç³»ç»Ÿ\"&#125;"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .failureHandler(<span class="keyword">new</span> AuthenticationFailureHandler() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAuthenticationFailure</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, AuthenticationException e)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">                        httpServletResponse.setContentType(<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">                        httpServletResponse.setStatus(<span class="number">401</span>);</span><br><span class="line">                        PrintWriter out = httpServletResponse.getWriter();</span><br><span class="line">                        <span class="comment">// è¾“å‡ºå¤±è´¥çš„åŸå› </span></span><br><span class="line">                        out.write(<span class="string">"&#123;\"error_code\":\"401\", \"name\":\""</span> + e.getClass() + <span class="string">"\", \"message\":\""</span> + e.getMessage() + <span class="string">"\"&#125;"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// ä½¿ç™»å½•é¡µä¸è®¾é™è®¿é—®</span></span><br><span class="line">                .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæˆåŠŸè¿‡åå¤±è´¥è¿‡åå°±ä¼šæœ‰ä¸€å®šçš„æç¤ºäº†ã€‚</p>]]></content:encoded>
      
      <comments>http://rongflag.github.io/posts/security1.html#disqus_thread</comments>
    </item>
    
    <item>
      <title>ä½ å¥½ä¸–ç•Œ</title>
      <link>http://rongflag.github.io/posts/hello_world.html</link>
      <guid>http://rongflag.github.io/posts/hello_world.html</guid>
      <pubDate>Tue, 03 Dec 2019 16:00:00 GMT</pubDate>
      <description>
      
        &lt;h1 id=&quot;Hello&quot;&gt;&lt;a href=&quot;#Hello&quot; class=&quot;headerlink&quot; title=&quot;Hello&quot;&gt;&lt;/a&gt;Hello&lt;/h1&gt;&lt;p&gt;ä½ å¥½ä¸–ç•Œ&lt;/p&gt;
      
      </description>
      
      
      <content:encoded><![CDATA[<h1 id="Hello"><a href="#Hello" class="headerlink" title="Hello"></a>Hello</h1><p>ä½ å¥½ä¸–ç•Œ</p><a id="more"></a><p>å…¨æ–‡å†…å®¹</p>]]></content:encoded>
      
      <comments>http://rongflag.github.io/posts/hello_world.html#disqus_thread</comments>
    </item>
    
  </channel>
</rss>
